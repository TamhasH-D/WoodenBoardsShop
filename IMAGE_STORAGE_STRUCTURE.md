# Новая структура хранения изображений

## Обзор изменений

Система хранения изображений была переписана для организации файлов в иерархическую структуру по продавцам и товарам.

### Старая структура
```
/uploads/products/
├── {product_id}_{image_id}.jpg
├── {product_id}_{image_id}.png
└── ...
```

### Новая структура
```
/uploads/sellers/
├── {seller_id}/
│   └── products/
│       ├── {product_id}/
│       │   ├── {image_id}.jpg
│       │   ├── {image_id}.png
│       │   └── ...
│       └── {another_product_id}/
│           └── ...
└── {another_seller_id}/
    └── products/
        └── ...
```

## Преимущества новой структуры

1. **Организация по продавцам**: Легко найти все изображения конкретного продавца
2. **Изоляция данных**: Файлы разных продавцов физически разделены
3. **Масштабируемость**: Лучшая производительность файловой системы при большом количестве файлов
4. **Безопасность**: Возможность настройки прав доступа на уровне продавца
5. **Простота резервного копирования**: Можно делать бэкапы по продавцам
6. **Автоматическая очистка**: Пустые папки удаляются автоматически

## Изменения в коде

### ImageService

#### Метод `save_image_file()`
- **Добавлен параметр**: `seller_id: UUID`
- **Новая логика**: Создает иерархическую структуру папок
- **Формат имени файла**: `{image_id}{extension}` (без префикса product_id)

```python
async def save_image_file(
    self,
    image: UploadFile,
    product_id: UUID,
    seller_id: UUID,  # НОВЫЙ ПАРАМЕТР
    image_id: UUID | None = None,
) -> str:
```

#### Новые методы
- `get_seller_product_dir(seller_id, product_id)` - получение пути к папке продукта
- `cleanup_empty_directories(image_path)` - очистка пустых папок после удаления

#### Обновленные методы
- `delete_image_file()` - теперь автоматически очищает пустые папки

### Обновления в routes

#### image_routes.py
- `upload_image()` - получает seller_id из product перед сохранением файла

#### product_routes.py  
- `create_product_with_analysis()` - использует ImageService вместо прямого сохранения

#### product_image_service.py
- `create_product_with_image()` - передает seller_id в ImageService
- `update_product_with_image()` - передает seller_id в ImageService

### Обновления в тестах

#### test_upload_image.py
- `test_upload_image_invalid_product()` - ожидает 404 вместо 500

## Миграция существующих файлов

Для миграции существующих файлов используйте скрипт `migrate_existing_images.py`:

```bash
python migrate_existing_images.py
```

Скрипт выполняет:
1. Получение всех изображений из базы данных
2. Получение информации о продавце для каждого изображения
3. Создание новой структуры папок
4. Перемещение файлов в новые папки
5. Обновление путей в базе данных
6. Очистку старых пустых папок
7. Проверку корректности миграции

## Обратная совместимость

- **API endpoints**: Не изменились, все существующие запросы работают
- **Frontend**: Не требует изменений, использует те же API
- **База данных**: Структура таблиц не изменилась
- **Конфигурация**: Использует существующие настройки

## Тестирование

Для тестирования новой структуры используйте:

```bash
python test_image_structure.py
```

Тест проверяет:
- Создание правильной структуры папок
- Сохранение файлов в правильные места
- Корректность содержимого файлов
- Удаление файлов и очистку пустых папок

## Мониторинг и обслуживание

### Проверка структуры папок
```bash
find /uploads/sellers -type d -empty  # Найти пустые папки
```

### Статистика по продавцам
```bash
du -sh /uploads/sellers/*/  # Размер данных по продавцам
```

### Очистка пустых папок (если нужно)
```bash
find /uploads/sellers -type d -empty -delete
```

## Производительность

- **Улучшение**: Меньше файлов в одной папке = быстрее работа файловой системы
- **Индексация**: Файловая система лучше индексирует иерархические структуры
- **Кэширование**: Операционная система эффективнее кэширует метаданные

## Безопасность

- **Изоляция**: Файлы разных продавцов физически разделены
- **Права доступа**: Можно настроить разные права на папки продавцов
- **Аудит**: Легче отслеживать операции с файлами конкретного продавца

## Резервное копирование

- **По продавцам**: Можно делать инкрементальные бэкапы по продавцам
- **Селективное восстановление**: Восстановление данных конкретного продавца
- **Параллелизация**: Бэкапы разных продавцов можно делать параллельно
