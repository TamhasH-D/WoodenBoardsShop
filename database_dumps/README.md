# База данных проекта "Магазин деревянных досок"

## Описание

Данная директория содержит SQL дампы базы данных PostgreSQL для дипломного проекта "Магазин деревянных досок". База данных содержит все необходимые таблицы для функционирования системы электронной коммерции деревянными изделиями.

## Файлы дампов

### 1. Полный дамп базы данных
- **Файл**: `diplom_database_full_YYYYMMDD_HHMMSS.sql`
- **Размер**: ~22KB
- **Содержимое**: Полная структура базы данных + все данные
- **Использование**: Для полного восстановления базы данных

### 2. Дамп структуры базы данных
- **Файл**: `diplom_database_schema_YYYYMMDD_HHMMSS.sql`
- **Размер**: ~19KB
- **Содержимое**: Только структура таблиц, индексы, ограничения
- **Использование**: Для создания пустой базы данных с правильной структурой

### 3. Дамп данных
- **Файл**: `diplom_database_data_YYYYMMDD_HHMMSS.sql`
- **Размер**: ~3KB
- **Содержимое**: Только данные таблиц (без структуры)
- **Использование**: Для загрузки данных в существующую базу

## Структура базы данных

### Основные таблицы

#### 1. **buyer** - Покупатели
- `id` (UUID) - Уникальный идентификатор
- `keycloak_uuid` (UUID) - Идентификатор в Keycloak
- `is_online` (Boolean) - Статус онлайн
- `last_activity` (Timestamp) - Последняя активность
- `created_at`, `updated_at` (Timestamp) - Временные метки

#### 2. **seller** - Продавцы
- `id` (UUID) - Уникальный идентификатор
- `keycloak_uuid` (UUID) - Идентификатор в Keycloak
- `is_online` (Boolean) - Статус онлайн
- `last_activity` (Timestamp) - Последняя активность
- `created_at`, `updated_at` (Timestamp) - Временные метки

#### 3. **wood_type** - Типы древесины
- `id` (UUID) - Уникальный идентификатор
- `neme` (VARCHAR) - Название типа древесины
- `description` (VARCHAR) - Описание

#### 4. **product** - Товары
- `id` (UUID) - Уникальный идентификатор
- `volume` (DOUBLE) - Объем в м³
- `price` (DOUBLE) - Цена в рублях
- `title` (VARCHAR) - Название товара
- `descrioption` (VARCHAR) - Описание товара
- `delivery_possible` (Boolean) - Возможность доставки
- `pickup_location` (VARCHAR) - Место самовывоза
- `seller_id` (UUID) - Ссылка на продавца
- `wood_type_id` (UUID) - Ссылка на тип древесины
- `created_at`, `updated_at` (Timestamp) - Временные метки

#### 5. **wooden_board** - Деревянные доски
- `id` (UUID) - Уникальный идентификатор
- `height` (DOUBLE) - Высота в см
- `width` (DOUBLE) - Ширина в см
- `length` (DOUBLE) - Длина в см (поле называется `lenght` из-за опечатки в бэкенде)
- `volume` (DOUBLE) - Объем в м³
- `confidence` (DOUBLE) - Уровень уверенности AI-распознавания
- `product_id` (UUID) - Ссылка на товар
- `image_id` (UUID) - Ссылка на изображение

#### 6. **image** - Изображения
- `id` (UUID) - Уникальный идентификатор
- `image_path` (VARCHAR) - Путь к файлу изображения
- `product_id` (UUID) - Ссылка на товар

#### 7. **wood_type_price** - Цены на типы древесины
- `id` (UUID) - Уникальный идентификатор
- `price_per_m3` (DOUBLE) - Цена за м³
- `wood_type_id` (UUID) - Ссылка на тип древесины
- `created_at` (Timestamp) - Дата создания

#### 8. **chat_thread** - Чат-потоки
- `id` (UUID) - Уникальный идентификатор
- `buyer_id` (UUID) - Ссылка на покупателя
- `seller_id` (UUID) - Ссылка на продавца
- `created_at` (Timestamp) - Дата создания

#### 9. **chat_message** - Сообщения чата
- `id` (UUID) - Уникальный идентификатор
- `message` (TEXT) - Текст сообщения
- `is_read_by_buyer` (Boolean) - Прочитано покупателем
- `is_read_by_seller` (Boolean) - Прочитано продавцом
- `thread_id` (UUID) - Ссылка на чат-поток
- `buyer_id` (UUID) - Ссылка на покупателя
- `seller_id` (UUID) - Ссылка на продавца
- `created_at` (Timestamp) - Дата создания

#### 10. **alembic_version** - Версии миграций
- `version_num` (VARCHAR) - Номер версии миграции Alembic

## Особенности базы данных

### Использование UUID
- Все основные таблицы используют UUID в качестве первичных ключей
- UUID генерируются на уровне приложения (фронтенд/бэкенд)
- Обеспечивает уникальность записей в распределенной системе

### Индексы
Созданы индексы для оптимизации запросов:
- Уникальные индексы на ID полях
- Индексы на внешние ключи
- Индексы на часто используемые поля (цена, объем, статус онлайн)

### Внешние ключи
Настроены каскадные удаления:
- При удалении продавца удаляются его товары
- При удалении товара удаляются связанные изображения и доски
- При удалении пользователей удаляются связанные чаты

### Временные метки
- Автоматическое проставление `created_at` и `updated_at`
- Использование timezone-aware timestamps

## Восстановление базы данных

### Полное восстановление
```bash
# Остановить приложение
docker-compose down

# Восстановить базу данных
psql -U backend -d postgres < diplom_database_full_YYYYMMDD_HHMMSS.sql

# Запустить приложение
docker-compose up -d
```

### Восстановление только структуры
```bash
psql -U backend -d backend < diplom_database_schema_YYYYMMDD_HHMMSS.sql
```

### Загрузка данных
```bash
psql -U backend -d backend < diplom_database_data_YYYYMMDD_HHMMSS.sql
```

## Информация о создании дампов

- **СУБД**: PostgreSQL 17.4
- **Кодировка**: UTF-8
- **Дата создания**: 09.06.2025 10:31 UTC
- **Версия схемы**: Актуальная версия Alembic
- **Статус данных**: Пустые таблицы (только структура)

## Примечания

1. **Опечатки в именах полей**: В базе данных сохранены опечатки из бэкенда для обратной совместимости:
   - `descrioption` вместо `description` в таблице `product`
   - `neme` вместо `name` в таблице `wood_type`
   - `lenght` вместо `length` в таблице `wooden_board`

2. **Пустые таблицы**: На момент создания дампа все таблицы пустые, содержат только структуру

3. **Миграции**: Используется Alembic для управления версиями схемы базы данных

4. **Безопасность**: Дампы не содержат чувствительных данных, так как аутентификация происходит через Keycloak
