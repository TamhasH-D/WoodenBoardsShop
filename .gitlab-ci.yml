# GitLab CI/CD Pipeline with Build and Deploy stages
# Simple pipeline that builds, tests, and deploys services

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# ============================================================================
# BUILD STAGE - Build all Docker containers
# ============================================================================

build_all_services:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache docker-compose
    - docker --version
    - docker-compose --version
    - cp ci/config/.env.ci .env
  script:
    - echo "üèóÔ∏è Building all services..."

    # Build backend services
    - echo "üì¶ Building backend services..."
    - cd backend/backend
    - docker-compose build --parallel
    - echo "‚úÖ Backend services built successfully"

    # Build frontend services (if they exist)
    - echo "üì¶ Building frontend services..."
    - cd ../../
    - |
      if [ -f "docker-compose.yaml" ]; then
        echo "Building all services from root docker-compose..."
        docker-compose build --parallel || echo "‚ö†Ô∏è Some frontend services failed to build (non-blocking)"
      else
        echo "No root docker-compose found, skipping frontend build"
      fi

    # Verify images were built
    - echo "üîç Verifying built images..."
    - docker images | grep -E "(backend|frontend|admin|seller|buyer)" || echo "‚ö†Ô∏è Some images not found"

    - echo "‚úÖ All services built successfully!"

  artifacts:
    paths:
      - .env
    expire_in: 1 hour
  only:
    - main
    - dev
    - merge_requests
  timeout: 20m

# ============================================================================
# TEST STAGE - Test services startup
# ============================================================================

test_backend:
  stage: test
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build_all_services
  before_script:
    - apk add --no-cache docker-compose curl
    - docker --version
    - docker-compose --version
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    # –ö–æ–ø–∏—Ä—É–µ–º CI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    - cp ci/config/.env.ci .env
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ backend —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    - echo "üì¶ –ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–æ–≤..."
    - cd backend/backend
    - docker-compose up -d --build
    
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    - echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (60 —Å–µ–∫—É–Ω–¥)..."
    - sleep 60
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    - docker-compose ps
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ API
    - echo "üìã –õ–æ–≥–∏ API:"
    - docker-compose logs api
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç
    - echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
    - docker-compose exec -T api python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs', timeout=10); print('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!')" || (echo "‚ùå API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!" && exit 1)
    
    - echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ!"
    
  after_script:
    - echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
    - cd backend/backend || true
    - docker-compose down || true
    - docker system prune -f || true
    
  only:
    - main
    - dev
    - merge_requests
    
  timeout: 15m

# ============================================================================
# DEPLOY STAGE - Deploy to environments
# ============================================================================

deploy_staging:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build_all_services
    - test_backend
  before_script:
    - apk add --no-cache docker-compose curl
    - docker --version
    - docker-compose --version
  script:
    - echo "üöÄ Deploying to STAGING environment..."

    # Copy CI configuration
    - cp ci/config/.env.ci .env

    # Deploy backend services
    - echo "üì¶ Deploying backend services to staging..."
    - cd backend/backend
    - docker-compose up -d --force-recreate

    # Wait for services to start
    - echo "‚è≥ Waiting for staging services to start..."
    - sleep 30

    # Health check
    - echo "ü©∫ Running staging health checks..."
    - docker-compose ps
    - docker-compose logs api --tail 20

    # Verify deployment
    - echo "‚úÖ Verifying staging deployment..."
    - |
      if docker-compose exec -T api python -c "
        import urllib.request
        try:
          with urllib.request.urlopen('http://localhost:8000/docs', timeout=10) as r:
            print('‚úÖ Staging API is healthy, status:', r.status)
        except Exception as e:
          print('‚ùå Staging API health check failed:', e)
          exit(1)
      "; then
        echo "‚úÖ Staging deployment successful!"
      else
        echo "‚ùå Staging deployment failed!"
        echo "üîÑ Rolling back..."
        docker-compose down
        exit 1
      fi

    - echo "üéâ Staging deployment completed successfully!"

  after_script:
    - echo "üßπ Staging cleanup (keeping services running)..."
    # Note: We don't stop services in staging, they should keep running

  environment:
    name: staging
    url: http://staging.yourdomain.com
  only:
    - dev
  timeout: 20m

deploy_production:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  dependencies:
    - build_all_services
    - test_backend
  before_script:
    - apk add --no-cache docker-compose curl
    - docker --version
    - docker-compose --version
  script:
    - echo "üöÄ Deploying to PRODUCTION environment..."

    # Copy production configuration
    - cp ci/config/.env.ci .env

    # Create backup of current production state
    - echo "üíæ Creating backup of current production state..."
    - |
      if docker-compose ps | grep -q "Up"; then
        echo "üì∏ Backing up current production containers..."
        docker-compose ps > production_backup_$(date +%Y%m%d_%H%M%S).txt
      fi

    # Deploy to production
    - echo "üì¶ Deploying to production..."
    - cd backend/backend
    - docker-compose up -d --force-recreate

    # Wait for services to start
    - echo "‚è≥ Waiting for production services to start..."
    - sleep 45

    # Comprehensive health checks
    - echo "ü©∫ Running production health checks..."
    - docker-compose ps
    - docker-compose logs api --tail 30

    # Verify production deployment
    - echo "‚úÖ Verifying production deployment..."
    - |
      if docker-compose exec -T api python -c "
        import urllib.request
        try:
          with urllib.request.urlopen('http://localhost:8000/docs', timeout=15) as r:
            print('‚úÖ Production API is healthy, status:', r.status)
        except Exception as e:
          print('‚ùå Production API health check failed:', e)
          exit(1)
      "; then
        echo "‚úÖ Production deployment successful!"
      else
        echo "‚ùå Production deployment failed!"
        echo "üîÑ Rolling back production deployment..."
        docker-compose down
        echo "‚ùå Production rollback completed. Manual intervention required."
        exit 1
      fi

    - echo "üéâ Production deployment completed successfully!"

  after_script:
    - echo "üßπ Production deployment cleanup..."
    # Note: We don't stop production services

  environment:
    name: production
    url: http://yourdomain.com
  only:
    - main
  when: manual  # Manual deployment to production
  timeout: 25m
