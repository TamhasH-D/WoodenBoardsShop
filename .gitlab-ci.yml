# –ü—Ä–æ—Å—Ç–æ–π GitLab CI/CD –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã
# –¶–µ–ª—å: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

stages:
  - test

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ backend —Å–µ—Ä–≤–∏—Å–æ–≤
test_backend:
  stage: test
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache docker-compose curl
    - docker --version
    - docker-compose --version
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    # –ö–æ–ø–∏—Ä—É–µ–º CI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    - cp ci/config/.env.ci .env
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ backend —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    - echo "üì¶ –ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–∏—Å–æ–≤..."
    - cd backend/backend
    - docker-compose up -d --build
    
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    - echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (60 —Å–µ–∫—É–Ω–¥)..."
    - sleep 60
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    - docker-compose ps
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ API
    - echo "üìã –õ–æ–≥–∏ API:"
    - docker-compose logs api
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç
    - echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
    - docker-compose exec -T api python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/docs', timeout=10); print('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!')" || (echo "‚ùå API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!" && exit 1)
    
    - echo "‚úÖ Backend —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ!"
    
  after_script:
    - echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
    - cd backend/backend || true
    - docker-compose down || true
    - docker system prune -f || true
    
  only:
    - main
    - dev
    - merge_requests
    
  timeout: 15m
