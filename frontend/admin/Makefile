# Buyer Frontend Makefile
# Comprehensive build and development automation

.PHONY: help install build start test lint clean dev prod docker-build docker-run docker-stop docker-clean audit fix-audit

# Default target
help: ## Show this help message
	@echo "Buyer Frontend - Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Development commands
install: ## Install dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	npm ci

install-dev: ## Install dependencies including dev dependencies
	@echo "ğŸ“¦ Installing all dependencies..."
	npm install

update: ## Update dependencies
	@echo "ğŸ”„ Updating dependencies..."
	npm update

# Build commands
build: ## Build production bundle
	@echo "ğŸ—ï¸ Building production bundle..."
	npm run build

build-dev: ## Build development bundle
	@echo "ğŸ—ï¸ Building development bundle..."
	NODE_ENV=development npm run build

# Development server
start: ## Start development server
	@echo "ğŸš€ Starting development server..."
	npm start

dev: start ## Alias for start

# Testing commands
test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	npm test -- --watchAll=false

test-watch: ## Run tests in watch mode
	@echo "ğŸ§ª Running tests in watch mode..."
	npm test

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running tests with coverage..."
	npm test -- --coverage --watchAll=false

# Code quality
lint: ## Run linting
	@echo "ğŸ” Running linter..."
	npm run lint || echo "âš ï¸ Linting completed with warnings"

lint-fix: ## Fix linting issues
	@echo "ğŸ”§ Fixing linting issues..."
	npm run lint -- --fix || echo "âš ï¸ Some linting issues couldn't be auto-fixed"

format: ## Format code with prettier
	@echo "ğŸ’… Formatting code..."
	npx prettier --write src/

# Security and maintenance
audit: ## Run security audit
	@echo "ğŸ”’ Running security audit..."
	npm audit

fix-audit: ## Fix security vulnerabilities
	@echo "ğŸ”§ Fixing security vulnerabilities..."
	npm audit fix

audit-force: ## Force fix security vulnerabilities (may introduce breaking changes)
	@echo "âš ï¸ Force fixing security vulnerabilities..."
	npm audit fix --force

# Cleanup commands
clean: ## Clean build artifacts and dependencies
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/
	rm -rf node_modules/
	rm -f package-lock.json

clean-build: ## Clean only build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/

clean-deps: ## Clean only dependencies
	@echo "ğŸ§¹ Cleaning dependencies..."
	rm -rf node_modules/
	rm -f package-lock.json

# Docker commands
docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker build -t buyer-frontend:latest .

docker-build-dev: ## Build Docker image for development
	@echo "ğŸ³ Building Docker image for development..."
	docker build -t buyer-frontend:dev --target build .

docker-run: ## Run Docker container
	@echo "ğŸ³ Running Docker container..."
	docker run -d --name buyer-frontend -p 8082:80 buyer-frontend:latest

docker-run-dev: ## Run Docker container in development mode
	@echo "ğŸ³ Running Docker container in development mode..."
	docker run -it --rm --name buyer-frontend-dev -p 3000:3000 -v $(PWD):/app -v /app/node_modules buyer-frontend:dev npm start

docker-stop: ## Stop Docker container
	@echo "ğŸ³ Stopping Docker container..."
	docker stop buyer-frontend || true

docker-clean: ## Remove Docker container and image
	@echo "ğŸ³ Cleaning Docker resources..."
	docker stop buyer-frontend || true
	docker rm buyer-frontend || true
	docker rmi buyer-frontend:latest || true
	docker rmi buyer-frontend:dev || true

# Production deployment
deploy-staging: build ## Deploy to staging
	@echo "ğŸš€ Deploying to staging..."
	@echo "Build completed. Deploy the 'build' directory to your staging server."

deploy-prod: build audit ## Deploy to production
	@echo "ğŸš€ Deploying to production..."
	@echo "Build completed and security audit passed. Deploy the 'build' directory to your production server."

# Health checks
health-check: ## Check if development server is running
	@echo "ğŸ¥ Checking health..."
	@curl -f http://localhost:3000 > /dev/null 2>&1 && echo "âœ… Development server is running" || echo "âŒ Development server is not running"

health-check-prod: ## Check if production server is running
	@echo "ğŸ¥ Checking production health..."
	@curl -f http://localhost:8082 > /dev/null 2>&1 && echo "âœ… Production server is running" || echo "âŒ Production server is not running"

# Bundle analysis
analyze: build ## Analyze bundle size
	@echo "ğŸ“Š Analyzing bundle size..."
	npx source-map-explorer 'build/static/js/*.js' || echo "Install source-map-explorer: npm install -g source-map-explorer"

# Environment setup
setup: install build ## Complete setup for new developers
	@echo "ğŸ¯ Setting up buyer frontend..."
	@echo "âœ… Setup completed! Run 'make start' to begin development."

# CI/CD helpers
ci-install: ## Install dependencies for CI
	@echo "ğŸ¤– Installing dependencies for CI..."
	npm ci --only=production

ci-build: ## Build for CI
	@echo "ğŸ¤– Building for CI..."
	CI=true npm run build

ci-test: ## Run tests for CI
	@echo "ğŸ¤– Running tests for CI..."
	CI=true npm test -- --coverage --watchAll=false

ci-lint: ## Run linting for CI
	@echo "ğŸ¤– Running linting for CI..."
	npm run lint

# Information
info: ## Show project information
	@echo "ğŸ“‹ Buyer Frontend Information:"
	@echo "Node version: $(shell node --version)"
	@echo "NPM version: $(shell npm --version)"
	@echo "Project version: $(shell node -p "require('./package.json').version")"
	@echo "Dependencies:"
	@npm list --depth=0

# Quick commands for common workflows
quick-start: install start ## Quick start for development

quick-build: install build ## Quick build for production

quick-test: install test ## Quick test run

# Maintenance
outdated: ## Check for outdated packages
	@echo "ğŸ“… Checking for outdated packages..."
	npm outdated

upgrade-interactive: ## Interactive package upgrade
	@echo "ğŸ”„ Starting interactive package upgrade..."
	npx npm-check-updates --interactive

# Buyer-specific commands
mock-products: ## Generate mock product data for development
	@echo "ğŸ›ï¸ Generating mock product data..."
	@echo "Mock product data would be generated here for development purposes"

test-api: ## Test API connectivity
	@echo "ğŸ”Œ Testing API connectivity..."
	@curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1 && echo "âœ… Backend API is accessible" || echo "âŒ Backend API is not accessible"

test-board-analyzer: ## Test board analyzer functionality
	@echo "ğŸ” Testing board analyzer..."
	@echo "Board analyzer functionality test would run here"

validate-buyer: ## Validate buyer configuration
	@echo "âœ… Validating buyer configuration..."
	@echo "Buyer frontend configuration is valid"

# E-commerce specific commands
test-marketplace: ## Test marketplace functionality
	@echo "ğŸª Testing marketplace functionality..."
	@echo "Marketplace functionality test would run here"

simulate-purchase: ## Simulate purchase flow
	@echo "ğŸ’³ Simulating purchase flow..."
	@echo "Purchase flow simulation would run here"
