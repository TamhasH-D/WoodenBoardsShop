# Тест-кейсы: CRUD операции Backend API

## TC-API-CRUD-001: Создание покупателя (POST /api/v1/buyers)
**Приоритет**: Критический  
**Теги**: `#backend` `#api` `#buyers` `#create` `#critical`

### Предусловия
- Backend API запущен и доступен
- База данных подключена

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/buyers` с телом:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440001",
  "keycloak_uuid": "550e8400-e29b-41d4-a716-446655440002",
  "is_online": true
}
```
2. Проверить статус ответа
3. Проверить структуру ответа

### Ожидаемый результат
- Статус ответа: 201 Created
- Тело ответа содержит созданного покупателя с указанным ID
- Поле `created_at` автоматически заполнено
- Поле `last_activity` установлено в текущее время

---

## TC-API-CRUD-002: Получение покупателя по ID (GET /api/v1/buyers/{id})
**Приоритет**: Критический  
**Теги**: `#backend` `#api` `#buyers` `#read` `#critical`

### Предусловия
- В базе данных существует покупатель с известным ID

### Шаги выполнения
1. Отправить GET запрос на `/api/v1/buyers/{existing_id}`
2. Проверить статус ответа
3. Проверить структуру и содержимое ответа

### Ожидаемый результат
- Статус ответа: 200 OK
- Тело ответа содержит данные покупателя:
  - `id`: UUID покупателя
  - `keycloak_uuid`: UUID из Keycloak
  - `is_online`: boolean статус
  - `created_at`: дата создания
  - `last_activity`: последняя активность

---

## TC-API-CRUD-003: Обновление покупателя (PATCH /api/v1/buyers/{id})
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#buyers` `#update` `#high`

### Предусловия
- В базе данных существует покупатель с известным ID

### Шаги выполнения
1. Отправить PATCH запрос на `/api/v1/buyers/{existing_id}` с телом:
```json
{
  "is_online": false,
  "last_activity": "2024-06-09T10:30:00Z"
}
```
2. Проверить статус ответа
3. Получить обновленного покупателя для проверки изменений

### Ожидаемый результат
- Статус ответа: 200 OK или 204 No Content
- Изменения сохранены в базе данных
- Неизмененные поля остались без изменений
- Поле `last_activity` обновлено

---

## TC-API-CRUD-004: Удаление покупателя (DELETE /api/v1/buyers/{id})
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#buyers` `#delete` `#high`

### Предусловия
- В базе данных существует покупатель без связанных записей

### Шаги выполнения
1. Отправить DELETE запрос на `/api/v1/buyers/{existing_id}`
2. Проверить статус ответа
3. Попытаться получить удаленного покупателя

### Ожидаемый результат
- Статус ответа: 200 OK или 204 No Content
- Покупатель удален из базы данных
- GET запрос на удаленного покупателя возвращает 404 Not Found

---

## TC-API-CRUD-005: Получение списка покупателей с пагинацией (GET /api/v1/buyers)
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#buyers` `#pagination` `#high`

### Предусловия
- В базе данных есть несколько покупателей (более 20)

### Шаги выполнения
1. Отправить GET запрос на `/api/v1/buyers?offset=0&limit=10`
2. Проверить структуру ответа
3. Отправить запрос на следующую страницу: `?offset=10&limit=10`
4. Сравнить результаты

### Ожидаемый результат
- Статус ответа: 200 OK
- Структура ответа:
```json
{
  "data": [...],
  "total": 25,
  "offset": 0,
  "limit": 10
}
```
- Первая страница содержит первые 10 записей
- Вторая страница содержит следующие 10 записей
- Общее количество (`total`) корректно

---

## TC-API-CRUD-006: Создание продукта с валидацией (POST /api/v1/products)
**Приоритет**: Критический  
**Теги**: `#backend` `#api` `#products` `#create` `#validation` `#critical`

### Предусловия
- Существуют продавец и тип древесины в базе данных

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/products` с телом:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440010",
  "neme": "Доски сосновые",
  "descrioption": "Качественные сосновые доски",
  "volume": 2.5,
  "price": 15000,
  "seller_id": "{existing_seller_id}",
  "wood_type_id": "{existing_wood_type_id}"
}
```
2. Проверить статус ответа и структуру

### Ожидаемый результат
- Статус ответа: 201 Created
- Продукт создан с указанными данными
- Поля с опечатками (`neme`, `descrioption`) сохранены как есть
- Связи с продавцом и типом древесины установлены

---

## TC-API-CRUD-007: Валидация обязательных полей при создании
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#validation` `#negative` `#high`

### Предусловия
- Backend API запущен

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/products` с пустым телом: `{}`
2. Отправить запрос с отсутствующими обязательными полями
3. Отправить запрос с невалидными типами данных
4. Проверить ответы на каждый запрос

### Ожидаемый результат
- Статус ответа: 422 Unprocessable Entity
- Тело ответа содержит детальные ошибки валидации
- Указаны конкретные поля с ошибками
- Сообщения об ошибках понятны и информативны

---

## TC-API-CRUD-008: Создание деревянной доски с расчетом объема
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#wooden_boards` `#create` `#calculation` `#high`

### Предусловия
- Существуют продукт и изображение в базе данных

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/wooden-boards` с телом:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440020",
  "height": 5.0,
  "width": 15.0,
  "lenght": 300.0,
  "volume": 0.0225,
  "confidence": 0.95,
  "product_id": "{existing_product_id}",
  "image_id": "{existing_image_id}"
}
```
2. Проверить создание записи
3. Проверить корректность расчета объема

### Ожидаемый результат
- Статус ответа: 201 Created
- Доска создана с указанными размерами
- Объем рассчитан корректно: 5 × 15 × 300 / 1000000 = 0.0225 м³
- Связи с продуктом и изображением установлены

---

## TC-API-CRUD-009: Обработка несуществующих ресурсов (404 ошибки)
**Приоритет**: Средний  
**Теги**: `#backend` `#api` `#error_handling` `#negative` `#medium`

### Предусловия
- Backend API запущен

### Шаги выполнения
1. Отправить GET запрос на несуществующий ресурс:
   `/api/v1/buyers/00000000-0000-0000-0000-000000000000`
2. Попытаться обновить несуществующий ресурс
3. Попытаться удалить несуществующий ресурс
4. Проверить ответы

### Ожидаемый результат
- Статус ответа: 404 Not Found
- Тело ответа содержит понятное сообщение об ошибке
- Сообщение указывает на конкретный ресурс
- API остается стабильным

---

## TC-API-CRUD-010: Создание чат-потока между покупателем и продавцом
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#chat_threads` `#create` `#high`

### Предусловия
- Существуют покупатель и продавец в базе данных

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/chat-threads` с телом:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440030",
  "buyer_id": "{existing_buyer_id}",
  "seller_id": "{existing_seller_id}"
}
```
2. Проверить создание потока
3. Проверить автоматическое заполнение даты создания

### Ожидаемый результат
- Статус ответа: 201 Created
- Чат-поток создан между указанными пользователями
- Поле `created_at` автоматически заполнено
- Связи с покупателем и продавцом установлены

---

## TC-API-CRUD-011: Создание сообщения в чате
**Приоритет**: Высокий  
**Теги**: `#backend` `#api` `#chat_messages` `#create` `#high`

### Предусловия
- Существует чат-поток между покупателем и продавцом

### Шаги выполнения
1. Отправить POST запрос на `/api/v1/chat-messages` с телом:
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440040",
  "message": "Здравствуйте! Интересует ваш товар.",
  "is_read_by_buyer": false,
  "is_read_by_seller": false,
  "thread_id": "{existing_thread_id}",
  "buyer_id": "{existing_buyer_id}",
  "seller_id": "{existing_seller_id}"
}
```
2. Проверить создание сообщения

### Ожидаемый результат
- Статус ответа: 201 Created
- Сообщение создано в указанном потоке
- Статусы прочтения установлены корректно
- Время создания зафиксировано

---

## TC-API-CRUD-012: Массовое получение данных с фильтрацией
**Приоритет**: Средний  
**Теги**: `#backend` `#api` `#filtering` `#performance` `#medium`

### Предусловия
- В базе данных есть продукты разных типов и цен

### Шаги выполнения
1. Отправить GET запрос с фильтрами:
   `/api/v1/products?wood_type_id={wood_type_id}&min_price=10000&max_price=50000`
2. Проверить результаты фильтрации
3. Проверить производительность запроса

### Ожидаемый результат
- Возвращаются только продукты, соответствующие фильтрам
- Фильтрация работает корректно
- Время ответа приемлемое (< 1 секунды)
- Пагинация работает с фильтрами
