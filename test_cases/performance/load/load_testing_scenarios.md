# Тест-кейсы: Нагрузочное тестирование

## TC-PERF-LOAD-001: Нагрузочное тестирование API эндпоинтов
**Приоритет**: Высокий  
**Теги**: `#performance` `#load` `#api` `#high`

### Предусловия
- Все сервисы запущены в production-режиме
- База данных содержит тестовые данные (1000+ записей каждого типа)
- Настроены инструменты мониторинга

### Параметры нагрузки
- **Пользователи**: 100 одновременных
- **Длительность**: 10 минут
- **Ramp-up**: 2 минуты
- **Целевые эндпоинты**: все CRUD операции

### Шаги выполнения

#### Этап 1: Подготовка нагрузки
1. Настроить Locust или аналогичный инструмент
2. Создать сценарии для каждого API эндпоинта:
   - GET /api/v1/products (70% запросов)
   - GET /api/v1/buyers (10% запросов)
   - POST /api/v1/products (10% запросов)
   - PATCH /api/v1/products/{id} (5% запросов)
   - DELETE /api/v1/products/{id} (5% запросов)

#### Этап 2: Выполнение нагрузочного теста
3. Запустить тест с постепенным увеличением нагрузки
4. Мониторить ключевые метрики:
   - Время отклика (response time)
   - Пропускная способность (throughput)
   - Процент ошибок (error rate)
   - Использование CPU и памяти

#### Этап 3: Анализ результатов
5. Собрать статистику по каждому эндпоинту
6. Проанализировать узкие места
7. Проверить стабильность системы

### Ожидаемые результаты
- **Время отклика**:
  - GET запросы: < 200ms (95-й перцентиль)
  - POST запросы: < 500ms (95-й перцентиль)
  - PATCH/DELETE: < 300ms (95-й перцентиль)
- **Пропускная способность**: > 500 RPS
- **Процент ошибок**: < 1%
- **Использование ресурсов**: CPU < 80%, RAM < 85%

---

## TC-PERF-LOAD-002: Нагрузочное тестирование AI-сервисов
**Приоритет**: Критический  
**Теги**: `#performance` `#load` `#ai` `#critical`

### Предусловия
- AI-сервисы запущены и доступны
- Подготовлены тестовые изображения разных размеров
- Настроен мониторинг GPU (если используется)

### Параметры нагрузки
- **Пользователи**: 20 одновременных
- **Длительность**: 15 минут
- **Изображения**: 5 разных размеров (1MP, 2MP, 5MP, 8MP, 12MP)

### Шаги выполнения

#### Этап 1: Тестирование детекции досок
1. Отправить 20 одновременных запросов на `/detect_seg/`
2. Использовать изображения разных размеров
3. Измерить время обработки каждого запроса
4. Проверить качество детекции под нагрузкой

#### Этап 2: Тестирование расчета объема
5. Отправить 20 одновременных запросов на `/wooden_boards_volume_seg/`
6. Варьировать параметры height и length
7. Измерить время полного цикла обработки
8. Проверить точность расчетов

#### Этап 3: Комбинированная нагрузка
9. Одновременно нагружать оба AI-сервиса
10. Мониторить взаимное влияние сервисов
11. Проверить стабильность при пиковой нагрузке

### Ожидаемые результаты
- **Время обработки изображений**:
  - 1MP: < 2 секунд
  - 5MP: < 5 секунд
  - 12MP: < 10 секунд
- **Пропускная способность**: > 3 изображения/секунду
- **Точность детекции**: не снижается под нагрузкой
- **Использование GPU**: < 90%
- **Память**: без утечек при длительной работе

---

## TC-PERF-LOAD-003: Нагрузочное тестирование фронтендов
**Приоритет**: Средний  
**Теги**: `#performance` `#load` `#frontend` `#medium`

### Предусловия
- Все фронтенды развернуты и доступны
- Настроен Selenium Grid или аналогичный инструмент
- Подготовлены тестовые аккаунты пользователей

### Параметры нагрузки
- **Браузеры**: 50 одновременных сессий
- **Длительность**: 20 минут
- **Сценарии**: типичные пользовательские действия

### Шаги выполнения

#### Этап 1: Buyer Frontend
1. 20 браузеров имитируют покупателей:
   - Просмотр каталога продуктов
   - Поиск и фильтрация
   - Просмотр деталей продуктов
   - Использование AI-анализатора
2. Измерить время загрузки страниц
3. Проверить отзывчивость интерфейса

#### Этап 2: Seller Frontend
4. 15 браузеров имитируют продавцов:
   - Создание и редактирование продуктов
   - Загрузка изображений
   - Работа с чатами
   - Просмотр статистики
5. Измерить время выполнения операций

#### Этап 3: Admin Frontend
6. 15 браузеров имитируют администраторов:
   - Управление всеми сущностями
   - Массовые операции
   - Просмотр отчетов
   - Мониторинг системы

### Ожидаемые результаты
- **Время загрузки страниц**: < 3 секунд
- **Время выполнения операций**: < 5 секунд
- **Отзывчивость интерфейса**: без зависаний
- **Использование памяти браузера**: стабильное
- **JavaScript ошибки**: отсутствуют

---

## TC-PERF-LOAD-004: Нагрузочное тестирование базы данных
**Приоритет**: Высокий  
**Теги**: `#performance` `#load` `#database` `#high`

### Предусловия
- PostgreSQL настроен для production
- База данных содержит большой объем тестовых данных
- Настроен мониторинг производительности БД

### Параметры нагрузки
- **Соединения**: 200 одновременных
- **Длительность**: 30 минут
- **Операции**: 80% чтение, 20% запись

### Шаги выполнения

#### Этап 1: Тестирование чтения
1. Выполнить массивные SELECT запросы:
   - Простые запросы по ID
   - Сложные JOIN запросы
   - Запросы с фильтрацией и сортировкой
   - Агрегационные запросы
2. Измерить время выполнения каждого типа

#### Этап 2: Тестирование записи
3. Выполнить операции записи:
   - INSERT новых записей
   - UPDATE существующих записей
   - DELETE записей
   - Массовые операции
4. Проверить целостность данных

#### Этап 3: Смешанная нагрузка
5. Комбинировать операции чтения и записи
6. Имитировать реальные паттерны использования
7. Тестировать при различных уровнях нагрузки

### Ожидаемые результаты
- **Время выполнения запросов**:
  - Простые SELECT: < 10ms
  - Сложные JOIN: < 100ms
  - INSERT/UPDATE: < 50ms
- **Пропускная способность**: > 1000 операций/секунду
- **Блокировки**: минимальные
- **Использование ресурсов**: CPU < 70%, I/O < 80%

---

## TC-PERF-LOAD-005: Тестирование файловых операций
**Приоритет**: Средний  
**Теги**: `#performance` `#load` `#files` `#medium`

### Предусловия
- Настроена файловая система для хранения изображений
- Подготовлены тестовые файлы разных размеров
- Настроен мониторинг дискового пространства

### Параметры нагрузки
- **Пользователи**: 30 одновременных
- **Файлы**: от 100KB до 10MB
- **Длительность**: 15 минут

### Шаги выполнения

#### Этап 1: Загрузка файлов
1. 30 пользователей одновременно загружают изображения
2. Варьировать размеры файлов
3. Измерить скорость загрузки
4. Проверить успешность операций

#### Этап 2: Обработка изображений
5. Отправить загруженные изображения на AI-анализ
6. Измерить время полного цикла
7. Проверить качество обработки

#### Этап 3: Скачивание файлов
8. Массово скачивать изображения
9. Проверить скорость отдачи файлов
10. Тестировать кэширование

### Ожидаемые результаты
- **Скорость загрузки**: > 1MB/сек на пользователя
- **Время обработки**: пропорционально размеру файла
- **Использование диска**: эффективное
- **Ошибки загрузки**: < 0.1%

---

## TC-PERF-LOAD-006: Комплексное нагрузочное тестирование
**Приоритет**: Критический  
**Теги**: `#performance` `#load` `#comprehensive` `#critical`

### Предусловия
- Вся система развернута в production-конфигурации
- Настроен полный мониторинг всех компонентов
- Подготовлены реалистичные тестовые сценарии

### Параметры нагрузки
- **Общие пользователи**: 200 одновременных
- **Длительность**: 60 минут
- **Сценарии**: реальные пользовательские паттерны

### Распределение нагрузки
- **Покупатели (60%)**: 120 пользователей
  - Просмотр каталога
  - Поиск продуктов
  - AI-анализ изображений
  - Общение в чатах
- **Продавцы (30%)**: 60 пользователей
  - Управление продуктами
  - Загрузка изображений
  - Ответы в чатах
  - Просмотр статистики
- **Администраторы (10%)**: 20 пользователей
  - Мониторинг системы
  - Управление пользователями
  - Модерация контента

### Шаги выполнения

#### Этап 1: Постепенное увеличение нагрузки
1. Начать с 20 пользователей
2. Каждые 5 минут добавлять по 20 пользователей
3. Достичь пиковой нагрузки в 200 пользователей
4. Поддерживать пик в течение 30 минут

#### Этап 2: Мониторинг всех компонентов
5. Отслеживать производительность API
6. Мониторить AI-сервисы
7. Контролировать состояние базы данных
8. Проверять отзывчивость фронтендов

#### Этап 3: Анализ результатов
9. Собрать метрики со всех компонентов
10. Выявить узкие места системы
11. Проанализировать паттерны деградации
12. Определить максимальную пропускную способность

### Ожидаемые результаты
- **Система выдерживает нагрузку** в 200 пользователей
- **Время отклика** остается приемлемым
- **Ошибки** составляют менее 2%
- **Все компоненты** работают стабильно
- **Ресурсы** используются эффективно
- **Система восстанавливается** после пиковой нагрузки
